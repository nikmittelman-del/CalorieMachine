<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>砖 拽专转 拽专专 转拽</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* 专转 转 爪注 转 砖 */
        :root {
            --dark-bg: #1c1e21;
            --card-bg: #2a2e35;
            --text-light: #ecf0f1;
            --primary-gradient: linear-gradient(135deg, #00c6ff, #0072ff);
            --secondary-gradient: linear-gradient(135deg, #ff6a00, #ee0979);
            --shadow-dark: 0 10px 30px rgba(0, 0, 0, 0.5);
            --border-radius: 16px;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-light);
            direction: rtl;
            text-align: right;
            padding: 40px 20px;
            line-height: 1.6;
            transition: background-color 0.5s;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 50px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        h1 {
            font-size: 3em;
            font-weight: 900;
            text-align: center;
            margin-bottom: 5px;
            background-image: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 5px rgba(0, 198, 255, 0.4);
        }
        
        .container > p {
            text-align: center;
            margin-bottom: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1em;
        }

        h2, h3 {
            color: var(--text-light);
            font-weight: 700;
            font-size: 1.8em;
            padding-bottom: 15px;
            margin-top: 40px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* 拽 */
        label {
            display: block;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 10px;
        }

        input[type="number"], select {
            width: 100%;
            padding: 14px 18px;
            border: none;
            border-radius: 10px;
            background-color: #3b3f46;
            color: var(--text-light);
            box-shadow: inset 5px 5px 10px #202327, inset -5px -5px 10px #343940;
            box-sizing: border-box;
            font-size: 16px;
            transition: all 0.3s ease;
            appearance: none;
        }

        input[type="number"]:focus, select:focus {
            background-color: #3f444c;
            outline: none;
            box-shadow: 0 0 0 2px #00c6ff, inset 2px 2px 5px #202327, inset -2px -2px 5px #343940;
        }
        
        /* 驻转专 */
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-left: 15px;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--text-light);
            box-shadow: 0 5px 15px rgba(0, 114, 255, 0.5);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            color: var(--text-light);
            box-shadow: 0 5px 15px rgba(238, 9, 121, 0.5);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            opacity: 0.9;
        }
        
        /* 转爪转 */
        #results {
            margin-top: 50px;
            padding: 40px;
            border-radius: var(--border-radius);
            background-color: #31363d;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.7s ease, transform 0.7s ease;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .result-item {
            margin-bottom: 20px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .result-label {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
        }

        .result-value {
            font-weight: 900;
            font-size: 1.5em;
            background-image: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        #target-calories {
            font-size: 3em;
            font-weight: 900;
            background-image: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(238, 9, 121, 0.6);
        }

        /* BMI Colors - 转拽 砖驻 转 爪注  */
        .bmi-normal { background-image: none; color: #2ecc71 !important; } /* 专拽 */
        .bmi-overweight { background-image: none; color: #f39c12 !important; } /* 转 */
        .bmi-obese { background-image: none; color: #e74c3c !important; } /*  */
        .bmi-underweight { background-image: none; color: #00c6ff !important; } /*  专 */ 

        .bmi-normal, .bmi-overweight, .bmi-obese, .bmi-underweight {
            /*  转 专 专砖  砖爪注  拽注 */
            background-image: none !important;
            -webkit-background-clip: initial !important; 
            -webkit-text-fill-color: initial !important; 
            color: inherit !important; 
        }

        /*   砖 -BMI 转 拽 爪注 砖    拽住 */
        #bmi-result { 
            background-image: none !important; 
            -webkit-background-clip: initial !important; 
            -webkit-text-fill-color: initial !important; 
        }

        
        /* 转 拽专 */
        .macro-table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-top: 25px;
            text-align: center;
        }

        .macro-table th, .macro-table td {
            padding: 15px 10px;
            border: none;
        }
        
        .macro-table th {
            background-color: #202327;
            color: #00c6ff;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .macro-table tr:nth-child(even) { background-color: #3b3f46; }
        .macro-table tr:nth-child(odd) { background-color: #31363d; }
        .macro-table tr:hover { background-color: #434851; }

        .macro-table td:nth-child(3) { color: #2ecc71; font-weight: bold; }
        .macro-table td:nth-child(4) { color: #f1c40f; font-weight: bold; }
        .macro-table td:nth-child(5) { color: #3498db; font-weight: bold; }
        
        .macro-table tr:last-child {
            font-size: 0.9em;
            font-style: italic;
        }


        /* 注转 */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .error { background-color: #3c1e20; color: #e74c3c; border: 1px solid #e74c3c; }
        .warning { background-color: #3c341e; color: #f39c12; border: 1px solid #f39c12; }
        
        /*  */
        .modal-container {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #31363d;
            color: var(--text-light);
            margin: auto;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-dark);
            text-align: right;
        }
        
        /*  砖 驻转专 住专 驻注 */
        .close-btn { 
            color: rgba(255, 255, 255, 0.6); 
            float: left; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus { color: #00c6ff; text-decoration: none; }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        
        .input-with-button {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .input-with-button > input {
            flex-grow: 1;
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

<div class="container">
    <h1>砖 拽专转 拽专专</h1>
    <p>注专 砖 爪专转 拽专转 转 转 (TDEE) 拽转 拽专 驻 注.</p>

    <div id="error-message" class="message error hidden">
          转  砖转 住 (*),  砖注专 .
    </div>
    <div id="age-warning-message" class="message warning hidden">
        <span id="age-warning-text"></span>
    </div>
    <div id="calorie-warning-message" class="message warning hidden">
        <span id="calorie-warning-text"></span>
    </div>

    <form id="calorie-form">
        <h2>转 住住</h2>
        <div class="input-grid">
            
            <div class="form-group">
                <label for="gender">* :</label>
                <select id="gender" required>
                    <option value="">专...</option>
                    <option value="male">专</option>
                    <option value="female">拽</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="age">*  (砖):</label>
                <input type="number" id="age" min="16" step="1" required> 
            </div>
            
            <div class="form-group">
                <label for="weight">* 砖拽 (拽"):</label>
                <input type="number" id="weight" min="1" step="0.1" required>
            </div>
            
            <div class="form-group">
                <label for="height">*  (住"):</label>
                <input type="number" id="height" min="1" step="1" required>
            </div>

            <div class="form-group">
                <label for="body-fat-percent"> 砖 ( ):</label>
                <div class="input-with-button">
                    <input type="number" id="body-fat-percent" min="1" max="50" step="0.1">
                    <button type="button" id="clear-bf-btn" class="btn btn-secondary" style="font-size: 14px; padding: 14px 10px;">拽</button>
                </div>
                <small id="bf-note"> , 砖转砖 住转 Katch-McArdle (拽转 转专).</small>
            </div>
            
        </div>

        <h2>驻注转 注</h2>
        <div class="input-grid">
            
            <div class="form-group">
                <label for="activity">* 专转 驻注转:</label>
                <select id="activity" required>
                    <option value="">专...</option>
                    <option value="sedentary">砖 (砖专/ )</option>
                    <option value="light">拽 ( 拽 1-3 砖注)</option>
                    <option value="moderate"> (  3-5 砖注)</option>
                    <option value="high"> ( 拽砖 6-7 砖注)</option>
                    <option value="extreme">拽爪 ( 驻/抓)</option>
                </select>
                <button type="button" id="open-modal-btn" class="btn btn-secondary" style="margin-top: 5px;"> 专转 驻注转 砖?</button>
            </div>
            
            <div class="form-group">
                <label for="goal">* 注 拽专:</label>
                <select id="goal" required>
                    <option value="">专...</option>
                    <option value="maintain">转拽 (砖专 注 砖拽)</option>
                    <option value="mild_cut"> 拽 (~250 拽专转 专注)</option>
                    <option value="moderate_cut">  (~500 拽专转 专注)</option>
                    <option value="mild_bulk">住 拽 (~250 拽专转 注祝)</option>
                    <option value="moderate_bulk">住 转 (~500 拽专转 注祝)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="macro-method">砖转 拽专:</label>
                <select id="macro-method">
                    <option value="grams_per_kg">住住 砖拽 (2.0  / 0.8 砖 / 驻 砖)</option>
                    <option value="percentage"> 拽专 (35%  / 25% 砖 / 40% 驻)</option>
                </select>
                <small>拽专 砖驻注 专拽 注 拽,  注 拽专转.</small>
            </div>
        </div>

        <div class="form-group" style="margin-top: 25px;">
            <button type="submit" id="calculate-btn" class="btn btn-primary">砖 拽专转</button>
            <button type="button" id="reset-btn" class="btn btn-secondary hidden">驻住 转</button>
            <button type="button" id="share-btn" class="btn btn-secondary">砖专 砖转祝</button>
            <button type="button" id="open-about-modal-btn" class="btn btn-secondary">转</button> 
        </div>
    </form>

    <div id="results" class="hidden">
        <h2> 住 转爪转</h2>
        
        <div class="result-item">
            <span class="result-label"> 住转 祝 (BMI):</span>
            <span id="bmi-result" class="result-value">--</span> 
        </div>
        
        <div class="result-item">
            <span class="result-label">爪专转 拽专转 转拽 (TDEE):</span>
            <span id="tdee-result" class="result-value">--</span>
        </div>
        
        <h3>注 拽专 : <span class="result-value" id="target-calories">--</span> 拽专转</h3>
        
        <hr>
        
        <h3>驻专 拽专专 (驻 砖 砖专)</h3>

        <h4>转拽 (Maintain)</h4>
        <table class="macro-table">
            <thead>
                <tr>
                    <th></th>
                    <th>拽专转 转</th>
                    <th></th>
                    <th>砖</th>
                    <th>驻</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="font-weight: bold;">转 (专)</td>
                    <td id="m-result">--</td>
                    <td id="m_p_g">--</td>
                    <td id="m_f_g">--</td>
                    <td id="m_c_g">--</td>
                </tr>
                 <tr>
                    <td style="font-weight: bold;">拽专转 (拽")</td>
                    <td>--</td>
                    <td id="m_p_cal">--</td>
                    <td id="m_f_cal">--</td>
                    <td id="m_c_cal">--</td>
                </tr>
                 <tr>
                    <td style="font-weight: bold;">拽 </td>
                    <td>100%</td>
                    <td id="m_p_p">--</td>
                    <td id="m_f_p">--</td>
                    <td id="m_c_p">--</td>
                </tr>
            </tbody>
        </table>

        <h4>  (~500 拽专转 专注)</h4>
        <table class="macro-table">
            <thead>
                <tr>
                    <th></th>
                    <th>拽专转 转</th>
                    <th></th>
                    <th>砖</th>
                    <th>驻</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="font-weight: bold;">转 (专)</td>
                    <td id="c-result">--</td>
                    <td id="c_p_g">--</td>
                    <td id="c_f_g">--</td>
                    <td id="c_c_g">--</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">拽专转 (拽")</td>
                    <td>--</td>
                    <td id="c_p_cal">--</td>
                    <td id="c_f_cal">--</td>
                    <td id="c_c_cal">--</td>
                </tr>
                 <tr>
                    <td style="font-weight: bold;">拽 </td>
                    <td>100%</td>
                    <td id="c_p_p">--</td>
                    <td id="c_f_p">--</td>
                    <td id="c_c_p">--</td>
                </tr>
            </tbody>
        </table>
        
        <h4>住 转 (~500 拽专转 注祝)</h4>
        <table class="macro-table">
            <thead>
                <tr>
                    <th></th>
                    <th>拽专转 转</th>
                    <th></th>
                    <th>砖</th>
                    <th>驻</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="font-weight: bold;">转 (专)</td>
                    <td id="b-result">--</td>
                    <td id="b_p_g">--</td>
                    <td id="b_f_g">--</td>
                    <td id="b_c_g">--</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">拽专转 (拽")</td>
                    <td>--</td>
                    <td id="b_p_cal">--</td>
                    <td id="b_f_cal">--</td>
                    <td id="b_c_cal">--</td>
                </tr>
                 <tr>
                    <td style="font-weight: bold;">拽 </td>
                    <td>100%</td>
                    <td id="b_p_p">--</td>
                    <td id="b_f_p">--</td>
                    <td id="b_c_p">--</td>
                </tr>
            </tbody>
        </table>
    </div>

    <p style="text-align: center; margin-top: 50px; font-size: 0.85em; color: rgba(255, 255, 255, 0.4);">
        转 爪专 漏 2025.  转 砖专转.
    </p>

</div> 

<div id="modal-container" class="modal-container hidden">
    <div class="modal-content">
        <span class="close-btn activity-close">&times;</span> 
        <h3>专转 专转 驻注转</h3>
        <p>专 转 专转 驻注转 转 转专 砖专 转 砖:</p>
        <ul>
            <li>**砖 (Sedentary):** 注 注  驻注转 驻转. 注转 砖专, 专  砖.</li>
            <li>**拽 (Light):**  拽 1-3  砖注.  拽, 注 砖转.</li>
            <li>** (Moderate):**  注爪转 转 3-5  砖注. 专爪 拽,  .</li>
            <li>** (High):**  注爪转  6-7  砖注.  拽砖, 注 驻转.</li>
            <li>**拽爪 (Extreme):**  , 驻,  注 驻转 爪转 .</li>
        </ul>
        <p><small> 注专.   , 转 注 "" 转 砖.</small></p>
    </div>
</div>

<div id="about-modal-container" class="modal-container hidden">
    <div class="modal-content">
        <span class="close-btn" id="about-close-btn">&times;</span>
        <h3>转 砖</h3>
        <p>砖  驻转    注专转 爪专转 拽专转 拽专专 转.</p>
        <h4>砖转 砖:</h4>
        <ul>
            <li>**BMR (拽爪 祝 专 住住):** 砖转砖 住转 **驻-住 '专** (Mifflin-St Jeor), 砖 砖转 拽转 转专 砖砖 .    砖, 砖 注专 砖转 **拽抓'-拽专** (Katch-McArdle) 拽转 转专 转.</li>
            <li>**TDEE (住" 爪转 专 转):** -BMR 驻 拽 驻注转.</li>
            <li>**注 拽专:** 转住住 注 专注/注祝 砖 0.25 拽"  0.5 拽" 砖注, 砖专  拽" 砖 注专 -7700 拽专转.</li>
        </ul>
        <p><strong>砖:</strong> 转   爪转 转   注抓 专驻  转转. 砖 转注抓 转 注 砖 拽爪注 驻 砖 砖注转 转.</p>
        <p dir="ltr">Version 1.7 - Final Fix for BMI Color/Visibility</p>
    </div>
</div>

<div id="share-modal-container" class="modal-container hidden">
    <div class="modal-content">
        <span class="close-btn" id="share-close-btn">&times;</span>
        <h3>拽砖专 砖转祝 砖专转 转</h3>
        <p>拽砖专   转 转 砖转. 转 砖专 转  砖转祝.</p>
        <input type="text" id="share-link-output" readonly style="width: 100%; margin-bottom: 15px; text-align: left;" />
        <button type="button" id="copy-link-btn" class="btn btn-primary" style="margin-left: 15px;">注转拽 拽砖专</button>
        <button type="button" id="download-file-btn" class="btn btn-secondary" style="margin-left: 0;">砖专 拽抓  (TXT)</button>
        <p id="copy-message" style="margin-top: 10px; color: #2ecc71;" class="hidden">拽砖专 注转拽 爪!</p>
        <p id="download-message" style="margin-top: 10px; color: #2ecc71;" class="hidden">拽抓  砖专 爪!</p>

        <p style="margin-top: 20px; font-size: 0.9em;">**砖 :** 砖 砖 转 拽专转 (抓 注 "砖 拽专转") 驻 砖专转 拽抓  爪专转 拽砖专.</p>
    </div>
</div>


<script>
    window.onload = function() {
        const form = document.getElementById('calorie-form');
        const resultsDiv = document.getElementById('results');
        const errorMessage = document.getElementById('error-message');
        const ageWarningDiv = document.getElementById('age-warning-message');
        const calorieWarningDiv = document.getElementById('calorie-warning-message');
        const resetBtn = document.getElementById('reset-btn');
        const bfInput = document.getElementById('body-fat-percent');
        const clearBfBtn = document.getElementById('clear-bf-btn');
        const bmiElement = document.getElementById('bmi-result');
        
        //  砖 
        const modalContainer = document.getElementById('modal-container');
        const aboutModalContainer = document.getElementById('about-modal-container');
        const shareModalContainer = document.getElementById('share-modal-container');

        const openModalBtn = document.getElementById('open-modal-btn');
        const openAboutModalBtn = document.getElementById('open-about-modal-btn');
        const shareBtn = document.getElementById('share-btn');

        // 驻转专 住专 
        const activityCloseBtn = document.querySelector('.activity-close');
        const aboutCloseBtn = document.getElementById('about-close-btn');
        const shareCloseBtn = document.getElementById('share-close-btn');

        //  转  砖转祝
        const shareLinkOutput = document.getElementById('share-link-output');
        const downloadFileBtn = document.getElementById('download-file-btn');
        const copyMessage = document.getElementById('copy-message');
        const downloadMessage = document.getElementById('download-message');
        const calorieWarningText = document.getElementById('calorie-warning-text');
        
        let lastCalculationResults = null; 

        // --- 驻拽爪转 注专 砖 ---

        function calculateMifflinBMR(gender, weight, height, age) {
            if (gender === 'male') {
                return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
        }

        function calculateKatchBMR(weight, bodyFatPercent) {
            const BF = bodyFatPercent / 100; 
            const LBM = weight * (1 - BF); 
            return 370 + (21.6 * LBM);
        }

        const activityMultipliers = {
            sedentary: 1.2,
            light: 1.375,
            moderate: 1.55,
            high: 1.725,
            extreme: 1.9
        };
        
        function calculateBMI(weight, height) {
            const heightMeters = height / 100;
            // 注转 拽 驻住  注专 拽  砖 -Infinity/NaN
            if (heightMeters <= 0.1) return NaN; 
            return weight / (heightMeters * heightMeters);
        }

        function getBMICategory(bmi) {
            let category, className;
            if (bmi < 18.5) {
                category = '转转-砖拽';
                className = 'bmi-underweight';
            } else if (bmi >= 18.5 && bmi <= 24.9) {
                category = '砖拽 转拽';
                className = 'bmi-normal';
            } else if (bmi >= 25 && bmi <= 29.9) {
                category = '注祝 砖拽';
                className = 'bmi-overweight';
            } else {
                category = '砖转 转专'; 
                className = 'bmi-obese';
            }
            return { category, className };
        }
        
        function getMacroNutrients(tdee, weight, macroMethod) {
            let proteinGrams, fatGrams, carbGrams;
            let proteinCals, fatCals, carbCals;
            let totalCalsFromMacro = tdee;

            if (totalCalsFromMacro === 0) totalCalsFromMacro = 1; 
            
            if (macroMethod === 'grams_per_kg') {
                if (weight <= 0 || isNaN(weight)) {
                    weight = 70; 
                }
                
                proteinGrams = 2.0 * weight; 
                proteinCals = proteinGrams * 4;
                fatGrams = 0.8 * weight;
                fatCals = fatGrams * 9;
                
                carbCals = tdee - proteinCals - fatCals;
                if (carbCals < 0) {
                    carbCals = 0; 
                    proteinCals = tdee * 0.4; 
                    fatCals = tdee * 0.25;
                    carbCals = tdee * 0.35;
                    proteinGrams = proteinCals / 4;
                    fatGrams = fatCals / 9;
                    carbGrams = carbCals / 4;
                }
                carbGrams = carbCals / 4;

            } else {
                const proteinPercent = 0.35; 
                const fatPercent = 0.25;   
                const carbPercent = 0.40;  
                
                proteinCals = tdee * proteinPercent;
                fatCals = tdee * fatPercent;
                carbCals = tdee * carbPercent;
                
                proteinGrams = proteinCals / 4;
                fatGrams = fatCals / 9;
                carbGrams = carbCals / 4;
            }

            return {
                proteinGrams: proteinGrams,
                fatGrams: fatGrams,
                carbGrams: carbGrams,
                
                proteinCals: proteinCals,
                fatCals: fatCals,
                carbCals: carbCals,

                proteinPercent: (proteinCals / totalCalsFromMacro) * 100,
                fatPercent: (fatCals / totalCalsFromMacro) * 100,
                carbPercent: (carbCals / totalCalsFromMacro) * 100
            };
        }
        
        function updateMacroResults(prefix, calories, weight, macroMethod) {
            const macro = getMacroNutrients(calories, weight, macroMethod);

            document.getElementById(`${prefix}-result`).textContent = Math.round(calories).toLocaleString();

            document.getElementById(`${prefix}_p_g`).textContent = Math.round(macro.proteinGrams).toLocaleString();
            document.getElementById(`${prefix}_f_g`).textContent = Math.round(macro.fatGrams).toLocaleString();
            document.getElementById(`${prefix}_c_g`).textContent = Math.round(macro.carbGrams).toLocaleString();
            
            document.getElementById(`${prefix}_p_cal`).textContent = Math.round(macro.proteinCals).toLocaleString();
            document.getElementById(`${prefix}_f_cal`).textContent = Math.round(macro.fatCals).toLocaleString();
            document.getElementById(`${prefix}_c_cal`).textContent = Math.round(macro.carbCals).toLocaleString();

            document.getElementById(`${prefix}_p_p`).textContent = `${Math.round(macro.proteinPercent)}%`;
            document.getElementById(`${prefix}_f_p`).textContent = `${Math.round(macro.fatPercent)}%`;
            document.getElementById(`${prefix}_c_p`).textContent = `${Math.round(macro.carbPercent)}%`;
            
            return macro;
        }

        // --- 驻拽爪 专砖转: 砖 砖专转 转爪转 专 ---
        
        function calculateAndDisplayResults(e) {
            if (e && e.preventDefault) { e.preventDefault(); }

            errorMessage.classList.add('hidden');
            ageWarningDiv.classList.add('hidden');
            calorieWarningDiv.classList.add('hidden');
            resultsDiv.style.opacity = '0';
            resultsDiv.style.transform = 'translateY(20px)';
            resultsDiv.classList.add('hidden');
            resetBtn.classList.add('hidden'); 
            
            // --- 拽转 转 ---
            const gender = document.getElementById('gender').value;
            const age = parseInt(document.getElementById('age').value) || 0; 
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const activityLevel = document.getElementById('activity').value;
            const goal = document.getElementById('goal').value;
            const bfPercentVal = bfInput.value;
            const bfPercent = bfPercentVal === "" ? NaN : parseFloat(bfPercentVal);
            const macroMethod = document.getElementById('macro-method').value;
            const macroMethodText = document.getElementById('macro-method').options[document.getElementById('macro-method').selectedIndex].text;

            // --- 转 拽 住住 ---
            if (!gender || age <= 0 || weight <= 0 || height <= 0 || !activityLevel || !goal) {
                errorMessage.classList.remove('hidden');
                return; 
            }

            // 转  (专拽 专)
            if (age < 16 && age > 0) {
                document.getElementById('age-warning-text').textContent = `砖  注  16 注.  转注抓 注 砖 拽爪注 注专 转 拽 转专.`;
                ageWarningDiv.classList.remove('hidden');
            }
            
            // 砖 BMR/TDEE
            let bmr;
            const isKatch = (!isNaN(bfPercent) && bfPercent > 0);
            if (isKatch) {
                bmr = calculateKatchBMR(weight, bfPercent);
            } else {
                bmr = calculateMifflinBMR(gender, weight, height, age);
            }
            const tdee = bmr * activityMultipliers[activityLevel];
            
            const weeklyCalorieDeficit = 7700;
            let calAdjustment;

            switch (goal) {
                case 'maintain': calAdjustment = 0; break;
                case 'mild_cut': calAdjustment = -(weeklyCalorieDeficit * 0.25) / 7; break; 
                case 'moderate_cut': calAdjustment = -(weeklyCalorieDeficit * 0.5) / 7; break; 
                case 'mild_bulk': calAdjustment = (weeklyCalorieDeficit * 0.25) / 7; break;
                case 'moderate_bulk': calAdjustment = (weeklyCalorieDeficit * 0.5) / 7; break;
                default: calAdjustment = 0;
            }

            let targetCalories = tdee + calAdjustment;
            const bmi = calculateBMI(weight, height);
            
            // 拽转 专转 拽专转 转
            const minCaloriesMale = 1500;
            const minCaloriesFemale = 1200;
            let minCalorieLimit = gender === 'male' ? minCaloriesMale : minCaloriesFemale;
            let finalTargetCalories = targetCalories;

            if (targetCalories < minCalorieLimit && goal.includes('cut')) {
                calorieWarningText.textContent = `爪专转 拽专转 转 砖转 (${Math.round(targetCalories).toLocaleString()} 拽专转)  住祝  抓 (${minCalorieLimit} 拽专转).  转注抓 注 砖 拽爪注. 注 拽专 注 -${minCalorieLimit} 拽专转.`;
                calorieWarningDiv.classList.remove('hidden');
                finalTargetCalories = minCalorieLimit; 
            }
            
            // 爪转 转爪转
            document.getElementById('target-calories').textContent = Math.round(finalTargetCalories).toLocaleString();
            document.getElementById('tdee-result').textContent = `住" ${Math.round(tdee).toLocaleString()} 拽专转 `;
            
            let bmiCategory = ' 注';
            let bmiClass = '';

            // 爪转 BMI - 驻 拽 爪注
            if (!isNaN(bmi) && isFinite(bmi) && bmi > 0) {
                 const { category, className } = getBMICategory(bmi);
                 bmiCategory = category;
                 bmiClass = className;
                 
                 bmiElement.textContent = `${bmi.toFixed(1)} (${bmiCategory})`;
                 // *** 转拽 拽专: 驻住 拽转 驻 住驻 驻 爪注 ***
                 bmiElement.className = 'result-value'; 
                 if (bmiClass) {
                     bmiElement.classList.add(bmiClass);
                 } else {
                     //  拽专  爪 (BMI 拽爪 转专 砖 住),  爪注 专
                     bmiElement.style.color = '#00c6ff';
                 }
            } else {
                 bmiElement.textContent = '--';
                 bmiElement.className = 'result-value'; 
                 bmiElement.style.color = 'gray';
            }
            
            // 砖 砖专转 拽专 专
            const macroMaintain = updateMacroResults('m', tdee, weight, macroMethod);
            const moderateCut = tdee - (weeklyCalorieDeficit * 0.5) / 7;
            const macroCut = updateMacroResults('c', moderateCut, weight, macroMethod);
            const moderateBulk = tdee + (weeklyCalorieDeficit * 0.5) / 7;
            const macroBulk = updateMacroResults('b', moderateBulk, weight, macroMethod);
            
            // 砖专转  转 (拽 驻) 砖转 
            lastCalculationResults = {
                timestamp: new Date().toLocaleString('he-IL'),
                input: {
                    gender, age, weight, height, activityLevel, goal,
                    bodyFatPercent: isKatch ? bfPercent : '  (住转 Mifflin-St Jeor)',
                    bmrFormula: isKatch ? 'Katch-McArdle' : 'Mifflin-St Jeor',
                    macroMethod: macroMethodText
                },
                output: {
                    bmi: isNaN(bmi) || !isFinite(bmi) ? 'N/A' : bmi.toFixed(1),
                    bmiCategory: bmiCategory,
                    bmr: Math.round(bmr),
                    tdee: Math.round(tdee),
                    targetCalories: Math.round(finalTargetCalories),
                    maintain: { calories: Math.round(tdee), macro: macroMaintain },
                    cut: { calories: Math.round(moderateCut), macro: macroCut },
                    bulk: { calories: Math.round(moderateBulk), macro: macroBulk }
                }
            };

            // 爪转 
            resultsDiv.classList.remove('hidden');
            setTimeout(() => {
                resultsDiv.style.opacity = '1';
                resultsDiv.style.transform = 'translateY(0)';
            }, 50); 
            resetBtn.classList.remove('hidden');
        }

        // --- 驻拽爪转 砖专转 拽抓 ---
        
        function downloadDataFile(data) {
            if (!data) {
                alert(' 砖 转 拽专转 驻 砖专转 拽抓.');
                return;
            }

            const fileName = `Calorie_Plan_${data.input.weight}kg_${new Date().getFullYear()}${new Date().getMonth()+1}${new Date().getDate()}.txt`;
            
            let fileContent = "=== 住 砖 拽专转 拽专专 ===\n";
            fileContent += `转专 砖: ${data.timestamp}\n\n`;

            fileContent += "--- 转 拽 ---\n";
            fileContent += `: ${data.input.gender === 'male' ? '专' : '拽'}\n`;
            fileContent += `: ${data.input.age} 砖\n`;
            fileContent += `砖拽: ${data.input.weight} 拽"\n`;
            fileContent += `: ${data.input.height} 住"\n`;
            fileContent += `驻注转: ${data.input.activityLevel}\n`;
            fileContent += ` 砖: ${data.input.bodyFatPercent}\n`;
            fileContent += `住转 BMR: ${data.input.bmrFormula}\n`;
            fileContent += `砖转 拽专: ${data.input.macroMethod}\n\n`;

            fileContent += "--- 转爪转 注拽专转 ---\n";
            fileContent += `BMR (住住): ${data.output.bmr} 拽专转\n`;
            fileContent += `TDEE (转拽): ${data.output.tdee} 拽专转\n`;
            fileContent += ` BMI: ${data.output.bmi} (${data.output.bmiCategory})\n`;
            fileContent += `**注  抓:** ${data.output.targetCalories} 拽专转\n\n`;
            
            // 驻专 拽专 ( 转 - 转拽)
            const maintain = data.output.maintain;
            fileContent += `--- 驻专 拽专 (转拽 - ${maintain.calories} 拽专转) ---\n`;
            fileContent += `: ${Math.round(maintain.macro.proteinGrams)} 专 | ${Math.round(maintain.macro.proteinCals)} 拽" | ${Math.round(maintain.macro.proteinPercent)}%\n`;
            fileContent += `砖: ${Math.round(maintain.macro.fatGrams)} 专 | ${Math.round(maintain.macro.fatCals)} 拽" | ${Math.round(maintain.macro.fatPercent)}%\n`;
            fileContent += `驻: ${Math.round(maintain.macro.carbGrams)} 专 | ${Math.round(maintain.macro.carbCals)} 拽" | ${Math.round(maintain.macro.carbPercent)}%\n\n`;

            fileContent += "--------------------------------------------------------\n";
            fileContent += "转   爪转 转. 砖 转注抓 注 砖 拽爪注.\n";


            const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 驻拽爪转 驻住 ---
        function resetCalculator() {
            document.getElementById('calorie-form').reset();
            document.getElementById('results').style.opacity = '0';
            document.getElementById('results').style.transform = 'translateY(20px)';
            setTimeout(() => {
                document.getElementById('results').classList.add('hidden');
            }, 500); 
            
            resetBtn.classList.add('hidden');
            errorMessage.classList.add('hidden');
            ageWarningDiv.classList.add('hidden');
            calorieWarningDiv.classList.add('hidden');
            document.getElementById('bf-note').textContent = ` , 砖转砖 住转 Katch-McArdle (拽转 转专).`;
            lastCalculationResults = null; // 驻住 转爪转 
        }

        // --- 专 专注 (Event Listeners) ---

        // 1. 专 驻转专 砖
        form.addEventListener('submit', calculateAndDisplayResults);
        
        // 2. 专 驻转专 驻住
        resetBtn.addEventListener('click', resetCalculator);

        // 3. 专 拽转  砖
        bfInput.addEventListener('input', function() {
            const note = document.getElementById('bf-note');
            if (this.value && parseFloat(this.value) > 0) {
                note.textContent = `专 住转 Katch-McArdle 砖 BMR (拽 转专).`;
            } else {
                note.textContent = ` , 砖转砖 住转 Katch-McArdle (拽转 转专).`;
            }
        });

        clearBfBtn.addEventListener('click', function(e) {
            e.preventDefault();
            bfInput.value = '';
            document.getElementById('bf-note').textContent = ` , 砖转砖 住转 Katch-McArdle (拽转 转专).`;
        });
        
        // 4. 专  砖转祝/砖专
        shareBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!lastCalculationResults) {
                alert('砖 砖 转 拽专转 驻 爪专转 拽砖专  砖专!');
                return;
            }

            const data = lastCalculationResults.input;
            const queryString = Object.keys(data).map(key => key + '=' + encodeURIComponent(data[key])).join('&');
            // 爪专转 拽砖专 URL 注 转 -hash
            shareLinkOutput.value = window.location.href.split('#')[0] + '#' + queryString; 

            copyMessage.classList.add('hidden');
            downloadMessage.classList.add('hidden');
            shareModalContainer.classList.remove('hidden');
        });

        // 5. 专 驻转专 砖专转 拽抓
        downloadFileBtn.addEventListener('click', function() {
            downloadDataFile(lastCalculationResults);
            copyMessage.classList.add('hidden');
            downloadMessage.classList.remove('hidden');
            setTimeout(() => downloadMessage.classList.add('hidden'), 3000);
        });

        // 6. 专 驻转专 注转拽转 拽砖专
        document.getElementById('copy-link-btn').addEventListener('click', function() {
            shareLinkOutput.select();
            document.execCommand('copy');
            copyMessage.classList.remove('hidden');
            downloadMessage.classList.add('hidden');
            setTimeout(() => copyMessage.classList.add('hidden'), 2000);
        });

        // 7. 专  驻注转
        openModalBtn.addEventListener('click', function(e) { e.preventDefault(); modalContainer.classList.remove('hidden'); });
        activityCloseBtn.addEventListener('click', function() { modalContainer.classList.add('hidden'); });

        // 8. 专  转
        openAboutModalBtn.addEventListener('click', function(e) { e.preventDefault(); aboutModalContainer.classList.remove('hidden'); });
        aboutCloseBtn.addEventListener('click', function() { aboutModalContainer.classList.add('hidden'); });
        
        // 9. 住专转  砖转祝
        shareCloseBtn.addEventListener('click', function() { shareModalContainer.classList.add('hidden'); });


        // 住专转  爪 抓
        window.onclick = function(event) {
            if (event.target === modalContainer) { modalContainer.classList.add('hidden'); }
            if (event.target === aboutModalContainer) { aboutModalContainer.classList.add('hidden'); }
            if (event.target === shareModalContainer) { shareModalContainer.classList.add('hidden'); }
        }
    }; // 住专转 window.onload
</script>

</body>
</html>